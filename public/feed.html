<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio ‚Äî INST¬∑ALACANT</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header data-component="SiteHeader" class="site-header">
  <div class="site-header__inner">
    <a href="feed.html" data-nav class="logo">INST¬∑ALACANT</a>
    <nav data-component="SiteNavBar" class="nav">
      <a href="feed.html" data-nav aria-current="page">Inicio</a>
      <a href="explorar.html" data-nav>Explorar</a>
      <a href="perfil.html" data-nav>Perfil</a>
      <a href="login.html" data-nav>Entrar</a>
    </nav>
  </div>
</header>

<main class="container" data-outlet>
  <!-- Composer -->
  <section data-component="PostComposer" class="card">
    <h1 class="mt-0">Inicio</h1>
    <div class="toolbar mt-2">
      <input id="composeInput" class="input" type="text" placeholder="¬øQu√© est√°s pensando?" aria-label="Componer publicaci√≥n" />
      <!-- input de imagen opcional (m√∫ltiple) -->
      <input id="composeFile" class="input" type="file" accept="image/*" multiple style="max-width:260px">
      <button id="publishBtn" class="button">Publicar</button>
    </div>
    <p class="muted mt-1">Sesi√≥n: <span id="whoami">Invitado</span></p>
  </section>

  <!-- Lista din√°mica -->
  <section data-component="PostList" class="post-list mt-4" id="feedList"></section>
</main>

<footer data-component="SiteFooter" class="site-footer">
  ¬© 2025 ‚Äî Inst¬∑alacant
</footer>

<!-- üîó ENLACE A LOS SERVICES -->
<script type="module">
  import { isLogged, currentUser } from '../js/services/auth.service.js';
  import { crearPublicacion, listarPublicaciones, eliminarPublicacion } from '../js/services/publicaciones.service.js';

  const $ = s => document.querySelector(s);
  const list = $('#feedList');
  const base = 'http://127.0.0.1:8090';

  const fileUrl = (item, filename) =>
    `${base}/api/files/${item.collectionId}/${item.id}/${filename}`;

  // Estado sesi√≥n
  const who = $('#whoami');
  if (who) who.textContent = isLogged() ? (currentUser()?.email || '‚Äî') : 'Invitado';

  // Pintar feed
  async function render(page = 1) {
    const res = await listarPublicaciones({ page, perPage: 10, sort: '-created' });
    list.innerHTML = res.items.map(p => {
      const imgs = (p.imagenes || []).map(name =>
        `<img class="post-card__image" src="${fileUrl(p, name)}" alt="" />`
      ).join('');
      return `
        <article data-component="PostCard" class="post-card">
          <header class="post-card__header">
            <div>
              <div class="post-card__user">${p.usuario ?? 'Usuario'}</div>
              <div class="post-card__meta">${new Date(p.created).toLocaleString()}</div>
            </div>
          </header>
          ${imgs}
          <div class="post-card__body"><p>${p.contenido ?? ''}</p></div>
          <div class="post-card__actions">
            ${isLogged() ? `<button class="button--ghost del" data-id="${p.id}">üóëÔ∏è Eliminar</button>` : ``}
          </div>
        </article>`;
    }).join('');

    // Bind eliminar
    list.querySelectorAll('.del').forEach(b => {
      b.addEventListener('click', async (e) => {
        await eliminarPublicacion(e.target.dataset.id);
        render();
      });
    });
  }

  // Publicar
  $('#publishBtn')?.addEventListener('click', async () => {
    if (!isLogged()) return alert('Inicia sesi√≥n');
    const contenido = $('#composeInput').value.trim();
    const files = Array.from($('#composeFile')?.files || []);
    if (!contenido && files.length === 0) return;

    await crearPublicacion({ contenido, archivos: files });
    $('#composeInput').value = '';
    if ($('#composeFile')) $('#composeFile').value = '';
    render();
  });

  render();
</script>
</body>
</html>
