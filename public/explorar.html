<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorar — INST·ALACANT</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header data-component="SiteHeader" class="site-header">
  <div class="site-header__inner">
    <a href="feed.html" data-nav class="logo">INST·ALACANT</a>
    <nav data-component="SiteNavBar" class="nav">
      <a href="feed.html" data-nav>Inicio</a>
      <a href="explorar.html" data-nav aria-current="page">Explorar</a>
      <a href="perfil.html" data-nav>Perfil</a>
      <a href="login.html" data-nav id="authLink">Entrar</a>
    </nav>
  </div>
</header>

<main class="container" data-outlet>
  <section data-component="ExploreToolbar" class="toolbar">
    <input id="searchBox" class="input" type="search" placeholder="Busca @usuario, texto o #hashtag" aria-label="Buscar" />
    <select id="categorySel" class="select" aria-label="Filtrar por categoría">
      <option value="">Todo</option>
      <option value="#fotografia">Fotografía</option>
      <option value="#arte">Arte</option>
      <option value="#viajes">Viajes</option>
    </select>
    <select id="orderSel" class="select" aria-label="Ordenar">
      <option value="-created">Recientes</option>
      <option value="popular">Populares</option>
    </select>
    <button id="clearBtn" class="button--ghost" type="button">Limpiar</button>
  </section>

  <section data-component="ExploreGrid" class="grid-3" id="grid"></section>

  <div class="mt-3" style="display:flex;justify-content:center">
    <button id="loadMore" class="button--ghost">Cargar más</button>
  </div>

  <p id="exploreErr" class="muted" style="color:#c00;display:none"></p>
</main>

<footer data-component="SiteFooter" class="site-footer">
  © 2025 — Inst·alacant
</footer>

<script type="module">
  import { listarPublicaciones } from '../js/services/publicaciones.service.js';
  import { isLogged, logout } from '../js/services/auth.service.js';

  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const errBox = $('#exploreErr');

  const BASE = 'http://127.0.0.1:8090';
  const fileUrl = (item, filename) => `${BASE}/api/files/${item.collectionId}/${item.id}/${filename}`;
  const userAvatarUrl = (u) => `${BASE}/api/files/_pb_users_auth_/${u.id}/${u.avatar}`;

  // Botón de autenticación dinámico
  const authLink = $('#authLink');
  if (isLogged()) {
    authLink.textContent = 'Cerrar sesión';
    authLink.href = '#';
    authLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('¿Seguro que quieres cerrar sesión?')) {
        logout();
        window.location.href = 'login.html';
      }
    });
  }

  // Estado de búsqueda/paginación
  let state = {
    q: '',
    category: '',
    order: '-created',
    page: 1,
    perPage: 9,
    loading: false,
    eof: false, // end of feed
  };

  // Helpers de filtros
  function extractHashtags(text) {
    if (!text) return [];
    const tags = text.match(/#\w+/g);
    return tags ? tags.map(t => t.toLowerCase()) : [];
  }

  function buildFilter({ q, category }) {
    const filters = [];

    // Categoría -> se interpreta como un hashtag más (si viene)
    const catTag = category?.trim();
    if (catTag) {
      filters.push(`Comentario ~ "${catTag}"`);
    }

    const query = q.trim();
    if (query) {
      if (query.startsWith('@')) {
        // Buscar por usuario: username o email contienen el término (sin @)
        const term = query.slice(1);
        filters.push(`id_usuario.username ~ "${term}" || id_usuario.email ~ "${term}"`);
      } else if (query.includes('#')) {
        // Buscar por hashtags: OR entre todos los hashtags detectados
        const tags = extractHashtags(query);
        if (tags.length) {
          filters.push(tags.map(t => `Comentario ~ "${t}"`).join(' || '));
        }
      } else {
        // Texto libre: Comentario o Ubicacion contienen el término
        filters.push(`Comentario ~ "${query}" || Ubicacion ~ "${query}"`);
      }
    }

    // Une condiciones (AND)
    return filters.length ? filters.join(' && ') : '';
  }

  function cardFromItem(p) {
    const imgs = (p.Imagen || []).map(name =>
      `<img class="post-card__image" src="${fileUrl(p, name)}" alt="">`
    ).join('');

    const autor = p.expand?.id_usuario;
    const avatar = autor?.avatar ? userAvatarUrl(autor) : 'img/avatar.png';
    const nombre = autor?.username || autor?.email || 'Usuario';

    const tags = extractHashtags(p.Comentario)
      .map(t => `<span class="muted" style="margin-right:.25rem">${t}</span>`).join('');

    return `
      <article data-component="PostCard" class="post-card">
        <header class="post-card__header">
          <img class="post-card__avatar" src="${avatar}" alt="Avatar" />
          <div>
            <div class="post-card__user">${nombre}</div>
            <div class="post-card__meta">${tags || '&nbsp;'}</div>
          </div>
        </header>
        ${imgs}
        <div class="post-card__body">
          <p>${p.Comentario ?? ''}</p>
        </div>
        <div class="post-card__actions">
          <button class="button--ghost" title="Me gusta" aria-label="Me gusta">❤️</button>
          <button class="button--ghost" title="Comentar" aria-label="Comentar">💬</button>
        </div>
      </article>
    `;
  }

  async function fetchAndRender({ reset = false } = {}) {
    if (state.loading || state.eof) return;
    state.loading = true; errBox.style.display = 'none';

    if (reset) {
      state.page = 1;
      state.eof = false;
      grid.innerHTML = '';
    }

    const filter = buildFilter({ q: state.q, category: state.category });

    // “Populares”: si aún no tienes campo de likes, dejamos mismo sort
    const sort = state.order === 'popular' ? '-created' : state.order;

    try {
      const res = await listarPublicaciones({
        page: state.page,
        perPage: state.perPage,
        sort,
        filter,
      });

      if (reset && res.items.length === 0) {
        grid.innerHTML = `<div class="card card--ghost">Sin resultados</div>`;
        state.eof = true;
        return;
      }

      // Pinta resultados
      const html = res.items.map(cardFromItem).join('');
      grid.insertAdjacentHTML('beforeend', html);

      // Fin de resultados
      if (res.items.length < state.perPage) {
        state.eof = true;
      } else {
        state.page += 1;
      }
    } catch (err) {
      console.error(err);
      errBox.textContent = 'No se pudo cargar resultados de exploración.';
      errBox.style.display = 'block';
    } finally {
      state.loading = false;
    }
  }

  // Eventos UI
  $('#searchBox').addEventListener('input', (e) => {
    state.q = e.target.value;
    // Debounce ligero: espera 250ms
    clearTimeout(window.__exploreTimer);
    window.__exploreTimer = setTimeout(() => fetchAndRender({ reset: true }), 250);
  });

  $('#categorySel').addEventListener('change', (e) => {
    state.category = e.target.value; // ej: "#viajes"
    fetchAndRender({ reset: true });
  });

  $('#orderSel').addEventListener('change', (e) => {
    state.order = e.target.value; // "-created" | "popular"
    fetchAndRender({ reset: true });
  });

  $('#clearBtn').addEventListener('click', () => {
    $('#searchBox').value = '';
    $('#categorySel').value = '';
    $('#orderSel').value = '-created';
    state.q = ''; state.category = ''; state.order = '-created';
    fetchAndRender({ reset: true });
  });

  $('#loadMore').addEventListener('click', () => fetchAndRender());

  // Primera carga
  fetchAndRender({ reset: true });
</script>
</body>
</html>
