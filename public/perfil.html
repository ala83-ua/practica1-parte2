<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil — INST·ALACANT</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="site-header">
  <div class="site-header__inner">
    <a href="feed.html" class="logo">INST·ALACANT</a>
    <nav class="nav">
      <a href="feed.html">Inicio</a>
      <a href="explorar.html">Explorar</a>
      <a href="perfil.html" aria-current="page">Perfil</a>
      <a href="login.html">Entrar</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1>Mi perfil</h1>
    <img id="avatarImg" alt="Avatar" style="width:96px;height:96px;border-radius:999px;object-fit:cover">
    <div class="mt-2">
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <button id="avatarBtn" class="button--ghost" type="button">Cambiar avatar</button>
    </div>
    <p class="muted mt-1">Email: <span id="emailOut"></span></p>
    <p class="muted">ID: <span id="idOut"></span></p>
    <p id="perfilErr" style="color:#c00;display:none"></p>
  </section>

  <!-- Mis publicaciones -->
  <section class="post-list mt-4" id="myPosts"></section>
</main>

<footer class="site-footer">© 2025 — Inst·alacant</footer>

<script type="module">
  import { currentUser, isLogged } from '../js/services/auth.service.js';
  import { listarPublicaciones, eliminarPublicacion } from '../js/services/publicaciones.service.js';
  import { actualizarUsuarioActual } from '../js/services/users.service.js';

  const BASE = 'http://127.0.0.1:8090';
  const $ = s => document.querySelector(s);
  const u = currentUser();

  // Datos básicos
  $('#emailOut').textContent = u?.email ?? 'Invitado';
  $('#idOut').textContent = u?.id ?? '-';

  // Avatar actual o placeholder (si añadiste campo "avatar" en users)
  const avatarEl = $('#avatarImg');
  avatarEl.src = (isLogged() && u?.avatar)
    ? `${BASE}/api/files/_pb_users_auth_/${u.id}/${u.avatar}`
    : 'img/avatar-1.png';

  // Cambiar avatar
  $('#avatarBtn').addEventListener('click', () => $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', async () => {
    const file = $('#avatarInput').files?.[0];
    if (!file) return;
    try {
      await actualizarUsuarioActual({ avatarFile: file });
      avatarEl.src = `${BASE}/api/files/_pb_users_auth_/${u.id}/${file.name}?v=${Date.now()}`;
      alert('Avatar actualizado');
    } catch (e) {
      console.error(e);
      $('#perfilErr').textContent = 'No se pudo actualizar el avatar.';
      $('#perfilErr').style.display = 'block';
    }
  });

  // Mis publicaciones (solo las mías)
  const cont = $('#myPosts');
  const fileUrl = (item, filename) => `${BASE}/api/files/${item.collectionId}/${item.id}/${filename}`;

  async function renderMine(page = 1) {
    const res = await listarPublicaciones({
      page, perPage: 10, sort: '-created',
      filter: `id_usuario = "${u.id}"`
    });
    cont.innerHTML = res.items.map(p => {
      const imgs = (p.imagenes || []).map(name =>
        `<img class="post-card__image" src="${fileUrl(p, name)}" alt="">`
      ).join('');
      return `
        <article class="post-card">
          <header class="post-card__header">
            <div>
              <div class="post-card__user">Yo</div>
              <div class="post-card__meta">${new Date(p.created).toLocaleString()}</div>
            </div>
          </header>
          ${imgs}
          <div class="post-card__body"><p>${p.comentario ?? ''}</p></div>
          <div class="post-card__actions">
            <button class="button--ghost del" data-id="${p.id}">🗑️ Eliminar</button>
          </div>
        </article>`;
    }).join('');

    cont.querySelectorAll('.del').forEach(b => {
      b.addEventListener('click', async (e) => {
        await eliminarPublicacion(e.target.dataset.id);
        renderMine();
      });
    });
  }

  if (isLogged()) renderMine();
</script>
</body>
</html>
