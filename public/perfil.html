<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil — INST·ALACANT</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="site-header">
  <div class="site-header__inner">
    <a href="feed.html" class="logo">INST·ALACANT</a>
    <nav class="nav">
      <a href="feed.html">Inicio</a>
      <a href="explorar.html">Explorar</a>
      <a href="perfil.html" aria-current="page">Perfil</a>
      <a href="login.html">Entrar</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1>Mi perfil</h1>
    <img id="avatarImg" alt="Avatar" style="width:96px;height:96px;border-radius:999px;object-fit:cover">
    <div class="mt-2">
      <input id="avatarInput" type="file" accept="image/*" style="display:none">
      <button id="avatarBtn" class="button--ghost" type="button">Cambiar avatar</button>
    </div>
    <p class="muted mt-1">Email: <span id="emailOut"></span></p>
    <p class="muted">ID: <span id="idOut"></span></p>
    <p id="perfilErr" style="color:#c00;display:none"></p>
  </section>

  <!-- Mis publicaciones -->
  <section class="post-list mt-4" id="myPosts"></section>
</main>

<footer class="site-footer">© 2025 — Inst·alacant</footer>

<script type="module">
  import { currentUser, isLogged } from '../js/services/auth.service.js';
  import { listarPublicaciones, eliminarPublicacion } from '../js/services/publicaciones.service.js';
  import { actualizarUsuarioActual } from '../js/services/users.service.js';

  const BASE = 'http://127.0.0.1:8090';
  const $ = s => document.querySelector(s);
  const u = currentUser();

  // Verificar si está logueado
  if (!isLogged()) {
    window.location.href = 'login.html';
  }

  // Datos básicos
  $('#emailOut').textContent = u?.email ?? 'Invitado';
  $('#idOut').textContent = u?.id ?? '-';

  // Avatar actual o placeholder
  const avatarEl = $('#avatarImg');
  const updateAvatarDisplay = () => {
    const user = currentUser();
    avatarEl.src = (user?.avatar)
      ? `${BASE}/api/files/_pb_users_auth_/${user.id}/${user.avatar}?v=${Date.now()}`
      : 'img/avatar.png';
  };
  updateAvatarDisplay();

  // Cambiar avatar
  $('#avatarBtn').addEventListener('click', () => $('#avatarInput').click());
  $('#avatarInput').addEventListener('change', async () => {
    const file = $('#avatarInput').files?.[0];
    if (!file) return;
    
    const btn = $('#avatarBtn');
    const errBox = $('#perfilErr');
    btn.disabled = true;
    btn.textContent = 'Subiendo...';
    errBox.style.display = 'none';
    
    try {
      await actualizarUsuarioActual({ avatarFile: file });
      updateAvatarDisplay();
      $('#avatarInput').value = ''; // Limpiar input
      
      // Mensaje de éxito temporal
      errBox.style.color = '#0a0';
      errBox.textContent = '✓ Avatar actualizado correctamente';
      errBox.style.display = 'block';
      setTimeout(() => { errBox.style.display = 'none'; }, 3000);
    } catch (e) {
      console.error(e);
      errBox.style.color = '#c00';
      errBox.textContent = 'No se pudo actualizar el avatar: ' + (e.message || 'Error desconocido');
      errBox.style.display = 'block';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Cambiar avatar';
    }
  });

  // Mis publicaciones (solo las mías)
  const cont = $('#myPosts');
  const fileUrl = (item, filename) => `${BASE}/api/files/${item.collectionId}/${item.id}/${filename}`;

  async function renderMine(page = 1) {
    try {
      const res = await listarPublicaciones({
        page, perPage: 10, sort: '-created',
        filter: `id_usuario = "${u.id}"`
      });
      
      if (res.items.length === 0 && page === 1) {
        cont.innerHTML = `
          <div class="card" style="text-align:center;padding:2rem;">
            <p class="muted">Aún no has publicado nada.</p>
            <p class="muted mt-1">Ve a <a href="feed.html">Inicio</a> para crear tu primera publicación.</p>
          </div>
        `;
        return;
      }
      
      cont.innerHTML = res.items.map(p => {
        const imgs = (p.Imagen || []).map(name =>
          `<img class="post-card__image" src="${fileUrl(p, name)}" alt="">`
        ).join('');
        return `
          <article class="post-card">
            <header class="post-card__header">
              <div>
                <div class="post-card__user">Yo</div>
                <div class="post-card__meta">${new Date(p.created).toLocaleString()}</div>
              </div>
            </header>
            ${imgs}
            <div class="post-card__body"><p>${p.Comentario ?? ''}</p></div>
            <div class="post-card__actions">
              <button class="button--ghost del" data-id="${p.id}">🗑️ Eliminar</button>
            </div>
          </article>`;
      }).join('');

      cont.querySelectorAll('.del').forEach(b => {
        b.addEventListener('click', async (e) => {
          if (confirm('¿Estás seguro de que quieres eliminar esta publicación?')) {
            try {
              await eliminarPublicacion(e.target.dataset.id);
              renderMine();
            } catch (err) {
              console.error(err);
              alert('No se pudo eliminar la publicación');
            }
          }
        });
      });
    } catch (err) {
      console.error(err);
      cont.innerHTML = `
        <div class="card" style="text-align:center;padding:2rem;color:#c00;">
          <p>Error al cargar las publicaciones.</p>
        </div>
      `;
    }
  }

  if (isLogged()) renderMine();
</script>
</body>
</html>
